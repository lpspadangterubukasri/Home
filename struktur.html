<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struktur Organisasi - LPS Padang Terubuk Asri</title>
    <style>
        /* [CSS SAMA PERSIS DENGAN SEBELUMNYA - TIDAK DIUBAH] */
        :root {
            --primary: #1a5f7a;
            --secondary: #159895;
            --accent: #57c5b6;
            --light: #f5f9fa;
            --green-light: #e8f5e9;
            --green-medium: #c8e6c9;
            --green-dark: #388e3c;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--light), #e8f5e9);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
            padding-top: 40px;
        }
        
        .header h1 {
            color: var(--green-dark);
            font-size: 2.8rem;
            margin-bottom: 15px;
            position: relative;
            display: inline-block;
        }
        
        .header h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 4px;
            background: linear-gradient(to right, var(--accent), var(--green-dark));
            border-radius: 2px;
        }
        
        .header p {
            color: #666;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 30px auto;
            line-height: 1.6;
        }
        
        /* [SISA CSS SAMA PERSIS...] */
        
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>STRUKTUR ORGANISASI</h1>
            <p>Lembaga Pengelola Sampah (LPS) Padang Terubuk Asri<br>Kelurahan Padang Terubuk, Kota Pekanbaru</p>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h3>Memuat data struktur organisasi...</h3>
            <p>Mengambil data dari spreadsheet Google Sheets</p>
        </div>
        
        <div id="orgChart" class="org-chart" style="display: none;">
            <!-- Level 1 - Ketua -->
            <div class="level-1">
                <div class="staff-card level-1-card" id="ketua-card">
                    <img src="" alt="Ketua" class="staff-photo" id="ketua-photo">
                    <div class="staff-info">
                        <h3 class="staff-name" id="ketua-name">Nama Ketua</h3>
                        <div class="staff-position" id="ketua-position">KETUA</div>
                    </div>
                </div>
                <div class="connector connector-vertical"></div>
            </div>
            
            <!-- Level 2 - Sekretaris & Bendahara -->
            <div class="level-2">
                <div class="connector connector-horizontal"></div>
                <div class="staff-card" id="sekretaris-card">
                    <img src="" alt="Sekretaris" class="staff-photo" id="sekretaris-photo">
                    <div class="staff-info">
                        <h3 class="staff-name" id="sekretaris-name">Nama Sekretaris</h3>
                        <div class="staff-position" id="sekretaris-position">SEKRETARIS</div>
                    </div>
                </div>
                
                <div class="staff-card" id="bendahara-card">
                    <img src="" alt="Bendahara" class="staff-photo" id="bendahara-photo">
                    <div class="staff-info">
                        <h3 class="staff-name" id="bendahara-name">Nama Bendahara</h3>
                        <div class="staff-position" id="bendahara-position">BENDAHARA</div>
                    </div>
                </div>
                <div class="connector connector-diagonal-left"></div>
                <div class="connector connector-diagonal-right"></div>
            </div>
            
            <!-- Level 3 - Bidang-bidang -->
            <div class="level-3">
                <div class="staff-card" id="angkutan-card">
                    <img src="" alt="Bidang Angkutan" class="staff-photo" id="angkutan-photo">
                    <div class="staff-info">
                        <h3 class="staff-name" id="angkutan-name">Nama Koordinator</h3>
                        <div class="staff-position" id="angkutan-position">KOORDINATOR</div>
                        <div class="staff-division">Bidang Angkutan Sampah</div>
                    </div>
                </div>
                
                <div class="staff-card" id="pengolahan-card">
                    <img src="" alt="Bidang Pengolahan" class="staff-photo" id="pengolahan-photo">
                    <div class="staff-info">
                        <h3 class="staff-name" id="pengolahan-name">Nama Koordinator</h3>
                        <div class="staff-position" id="pengolahan-position">KOORDINATOR</div>
                        <div class="staff-division">Bidang Pengolahan Sampah dan Edukasi</div>
                    </div>
                </div>
                
                <div class="staff-card" id="iuran-card">
                    <img src="" alt="Bidang Iuran" class="staff-photo" id="iuran-photo">
                    <div class="staff-info">
                        <h3 class="staff-name" id="iuran-name">Nama Koordinator</h3>
                        <div class="staff-position" id="iuran-position">KOORDINATOR</div>
                        <div class="staff-division">Bidang Pemungutan Iuran</div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color color-leadership"></div>
                    <span>Pimpinan</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-staff"></div>
                    <span>Staff & Koordinator</span>
                </div>
            </div>
        </div>
        
        <div id="errorState" class="error-state" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h2>Gagal Memuat Data</h2>
            <p>Terjadi kesalahan saat mengambil data dari spreadsheet. Pastikan:</p>
            <ul style="text-align: left; max-width: 400px; margin: 20px auto;">
                <li>Spreadsheet sudah dipublikasikan</li>
                <li>Koneksi internet stabil</li>
                <li>Format data sesuai template</li>
            </ul>
            <button class="refresh-btn" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Coba Lagi
            </button>
            
            <!-- Tampilkan data dummy untuk testing -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <p><strong>Untuk testing:</strong></p>
                <button class="refresh-btn" id="useDemoBtn" style="background: linear-gradient(135deg, #6c757d, #495057);">
                    <i class="fas fa-users"></i> Gunakan Data Demo
                </button>
            </div>
        </div>
        
        <div class="back-container">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Kembali ke Beranda
            </a>
        </div>
    </div>
    
    <script>
        // ========== KONFIGURASI UTAMA ==========
        // Pilih salah satu metode di bawah:
        
        // METODE 1: CSV Export (Paling Mudah & Aman)
        const USE_CSV_METHOD = true;
        
        // METODE 2: JSON API (Butuh API Key)
        const USE_JSON_API = false;
        const API_KEY = 'YOUR_API_KEY_HERE'; // Ganti dengan API key Anda
        
        // ID Spreadsheet Anda
        const SPREADSHEET_ID = '1RNLvI_ZRakyGsnEEWEoJ7Fb2GrZ-UMGih1Ceh49CFXw';
        const SHEET_NAME = 'BAGAN_LPS';
        
        // ========== END KONFIGURASI ==========
        
        // URL untuk CSV Export (Tidak butuh API Key)
        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vRsnWU14U24NGfpzbsqgPdfLbv84rnvmxFGO9kHV18THbkMGYL_tkeduSH0o3EjK22wVNRk0HMxudlM/pub?gid=0&single=true&output=csv`;
        
        // URL untuk JSON API (Butuh API Key)
        const JSON_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
        
        // DOM Elements
        const loadingElement = document.getElementById('loading');
        const orgChartElement = document.getElementById('orgChart');
        const errorStateElement = document.getElementById('errorState');
        const refreshButton = document.getElementById('refreshBtn');
        const useDemoButton = document.getElementById('useDemoBtn');
        
        // Staff card elements
        const staffElements = {
            ketua: {
                name: document.getElementById('ketua-name'),
                position: document.getElementById('ketua-position'),
                photo: document.getElementById('ketua-photo'),
                card: document.getElementById('ketua-card')
            },
            sekretaris: {
                name: document.getElementById('sekretaris-name'),
                position: document.getElementById('sekretaris-position'),
                photo: document.getElementById('sekretaris-photo'),
                card: document.getElementById('sekretaris-card')
            },
            bendahara: {
                name: document.getElementById('bendahara-name'),
                position: document.getElementById('bendahara-position'),
                photo: document.getElementById('bendahara-photo'),
                card: document.getElementById('bendahara-card')
            },
            angkutan: {
                name: document.getElementById('angkutan-name'),
                position: document.getElementById('angkutan-position'),
                photo: document.getElementById('angkutan-photo'),
                card: document.getElementById('angkutan-card')
            },
            pengolahan: {
                name: document.getElementById('pengolahan-name'),
                position: document.getElementById('pengolahan-position'),
                photo: document.getElementById('pengolahan-photo'),
                card: document.getElementById('pengolahan-card')
            },
            iuran: {
                name: document.getElementById('iuran-name'),
                position: document.getElementById('iuran-position'),
                photo: document.getElementById('iuran-photo'),
                card: document.getElementById('iuran-card')
            }
        };
        
        // Default fallback photo
        const DEFAULT_PHOTO = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI5MCIgZmlsbD0iI0U4RjVFOSIvPjxwYXRoIGQ9Ik0xMDAgMTEwQzExNi41NjkgMTEwIDEzMCA5Ni41Njg1IDEzMCA4MEMxMzAgNjMuNDMxNSAxMTYuNTY5IDUwIDEwMCA1MEM4My40MzE0IDUwIDcwIDYzLjQzMTUgNzAgODBDNzAgOTYuNTY4NSA4My40MzE0IDExMCAxMDAgMTEwWiIgZmlsbD0iIzU3QzVCNiIvPjxwYXRoIGQ9Ik0xMzAgMTIwSDEwMEM3MC40MzE0IDEyMCA0Ni42NjQyIDE0My40MDggNTAuNTE5NiAxNzIuNTJDNTIuMzMzNSAxODYuNTg1IDY0LjY5NzYgMTk3LjUgODAgMTk3LjVIMTUwQzE2NS4zMDIgMTk3LjUgMTc3LjY2NiAxODYuNTg1IDE3OS40OCAxNzIuNTJDMTgzLjMzNiAxNDMuNDA4IDE1OS41NjkgMTIwIDEzMCAxMjBaIiBmaWxsPSIjNTdDNUI2Ii8+PC9zdmc+';
        
        // ========== FUNGSI UTAMA ==========
        
        // Fungsi utama untuk mengambil data
        async function fetchData() {
            try {
                showLoading();
                
                let data;
                
                if (USE_CSV_METHOD) {
                    data = await fetchCSVData();
                } else if (USE_JSON_API) {
                    data = await fetchJSONData();
                } else {
                    throw new Error('Silakan pilih metode pengambilan data');
                }
                
                if (!data || data.length === 0) {
                    throw new Error('Data spreadsheet kosong');
                }
                
                // Proses data
                processData(data);
                
                // Tampilkan chart
                showOrgChart();
                addHoverEffects();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showError();
            }
        }
        
        // Fungsi untuk mengambil data CSV
        async function fetchCSVData() {
            try {
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                return parseCSV(csvText);
                
            } catch (error) {
                console.error('CSV Error:', error);
                // Coba metode alternatif
                return await fetchJSONPData();
            }
        }
        
        // Fungsi untuk parse CSV
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            lines.forEach(line => {
                if (line.trim()) {
                    // Parse CSV dengan handling quotes
                    const row = [];
                    let inQuotes = false;
                    let currentField = '';
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    
                    row.push(currentField.trim());
                    result.push(row);
                }
            });
            
            return result;
        }
        
        // Fungsi alternatif: JSONP untuk Google Sheets
        async function fetchJSONPData() {
            return new Promise((resolve, reject) => {
                // Format URL untuk JSON publik
                const jsonUrl = `https://spreadsheets.google.com/feeds/cells/${SPREADSHEET_ID}/1/public/full?alt=json`;
                
                // Buat script untuk JSONP
                const script = document.createElement('script');
                script.src = `${jsonUrl}&callback=handleJSONPData`;
                
                // Fungsi callback global
                window.handleJSONPData = function(data) {
                    document.head.removeChild(script);
                    delete window.handleJSONPData;
                    
                    if (data && data.feed && data.feed.entry) {
                        const cells = data.feed.entry;
                        const maxCol = Math.max(...cells.map(cell => parseInt(cell.gs$cell.col)));
                        const maxRow = Math.max(...cells.map(cell => parseInt(cell.gs$cell.row)));
                        
                        // Reconstruct grid
                        const grid = Array(maxRow).fill().map(() => Array(maxCol).fill(''));
                        
                        cells.forEach(cell => {
                            const row = parseInt(cell.gs$cell.row) - 1;
                            const col = parseInt(cell.gs$cell.col) - 1;
                            grid[row][col] = cell.gs$cell.$t || '';
                        });
                        
                        resolve(grid);
                    } else {
                        reject(new Error('Invalid JSONP data'));
                    }
                };
                
                script.onerror = () => {
                    document.head.removeChild(script);
                    delete window.handleJSONPData;
                    reject(new Error('JSONP request failed'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Fungsi untuk mengambil data JSON API
        async function fetchJSONData() {
            const response = await fetch(JSON_URL);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data.values || [];
        }
        
        // Fungsi untuk memproses data
        function processData(data) {
            // Ambil baris pertama (header/data)
            const row = data[0] || [];
            
            // Mapping kolom berdasarkan struktur Anda
            const columnMapping = {
                KETUA_NAME: 0,        // A
                KETUA_POSITION: 1,    // B
                KETUA_PHOTO: 2,       // C
                SEKRETARIS_NAME: 3,   // D
                SEKRETARIS_POSITION: 4, // E
                SEKRETARIS_PHOTO: 5,  // F
                BENDAHARA_NAME: 6,    // G
                BENDAHARA_POSITION: 7, // H
                BENDAHARA_PHOTO: 8,   // I
                ANGKUTAN_NAME: 9,     // J
                ANGKUTAN_POSITION: 10, // K
                ANGKUTAN_PHOTO: 11,   // L
                PENGOLAHAN_NAME: 12,  // M
                PENGOLAHAN_POSITION: 13, // N
                PENGOLAHAN_PHOTO: 14, // O
                IURAN_NAME: 15,       // P
                IURAN_POSITION: 16,   // Q
                IURAN_PHOTO: 17       // R
            };
            
            // Update data untuk setiap staff
            updateStaff(staffElements.ketua, 
                       row[columnMapping.KETUA_NAME], 
                       row[columnMapping.KETUA_POSITION], 
                       row[columnMapping.KETUA_PHOTO]);
            
            updateStaff(staffElements.sekretaris, 
                       row[columnMapping.SEKRETARIS_NAME], 
                       row[columnMapping.SEKRETARIS_POSITION], 
                       row[columnMapping.SEKRETARIS_PHOTO]);
            
            updateStaff(staffElements.bendahara, 
                       row[columnMapping.BENDAHARA_NAME], 
                       row[columnMapping.BENDAHARA_POSITION], 
                       row[columnMapping.BENDAHARA_PHOTO]);
            
            updateStaff(staffElements.angkutan, 
                       row[columnMapping.ANGKUTAN_NAME], 
                       row[columnMapping.ANGKUTAN_POSITION], 
                       row[columnMapping.ANGKUTAN_PHOTO]);
            
            updateStaff(staffElements.pengolahan, 
                       row[columnMapping.PENGOLAHAN_NAME], 
                       row[columnMapping.PENGOLAHAN_POSITION], 
                       row[columnMapping.PENGOLAHAN_PHOTO]);
            
            updateStaff(staffElements.iuran, 
                       row[columnMapping.IURAN_NAME], 
                       row[columnMapping.IURAN_POSITION], 
                       row[columnMapping.IURAN_PHOTO]);
        }
        
        // Fungsi untuk update data staff
        function updateStaff(staffElement, name = '', position = '', photoUrl = '') {
            name = name || 'Data tidak tersedia';
            position = position || 'Jabatan';
            
            staffElement.name.textContent = name;
            staffElement.position.textContent = position;
            
            // Handle foto
            if (photoUrl && isValidUrl(photoUrl)) {
                staffElement.photo.src = photoUrl;
                staffElement.photo.onerror = () => {
                    staffElement.photo.src = DEFAULT_PHOTO;
                };
            } else {
                staffElement.photo.src = DEFAULT_PHOTO;
            }
        }
        
        // Fungsi untuk cek URL valid
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // ========== FUNGSI DEMO ==========
        
        // Fungsi untuk menggunakan data demo
        function useDemoData() {
            showLoading();
            
            // Data demo untuk testing
            const demoData = [
                [
                    "Bapak Ketua", "Ketua LPS", "https://via.placeholder.com/150x150/1a5f7a/FFFFFF?text=KETUA",
                    "Bapak Sekretaris", "Sekretaris", "https://via.placeholder.com/150x150/159895/FFFFFF?text=SEKRETARIS",
                    "Bapak Bendahara", "Bendahara", "https://via.placeholder.com/150x150/57c5b6/FFFFFF?text=BENDAHARA",
                    "Bapak Angkutan", "Koordinator", "https://via.placeholder.com/150x150/388e3c/FFFFFF?text=ANGKUTAN",
                    "Bapak Pengolahan", "Koordinator", "https://via.placeholder.com/150x150/4CAF50/FFFFFF?text=PENGOLAHAN",
                    "Bapak Iuran", "Koordinator", "https://via.placeholder.com/150x150/8BC34A/FFFFFF?text=IURAN"
                ]
            ];
            
            // Proses data demo
            processData(demoData);
            
            // Tampilkan
            showOrgChart();
            addHoverEffects();
            
            // Tampilkan pesan bahwa ini data demo
            const message = document.createElement('div');
            message.style.cssText = `
                text-align: center;
                padding: 10px;
                background: #fff3cd;
                color: #856404;
                border-radius: 5px;
                margin: 10px auto;
                max-width: 500px;
                border: 1px solid #ffeaa7;
            `;
            message.innerHTML = `<i class="fas fa-info-circle"></i> Sedang menampilkan data demo. Pastikan spreadsheet Anda sudah dipublikasikan.`;
            document.querySelector('.header').appendChild(message);
        }
        
        // ========== HELPER FUNCTIONS ==========
        
        function showLoading() {
            loadingElement.style.display = 'block';
            orgChartElement.style.display = 'none';
            errorStateElement.style.display = 'none';
        }
        
        function showOrgChart() {
            loadingElement.style.display = 'none';
            orgChartElement.style.display = 'block';
            errorStateElement.style.display = 'none';
        }
        
        function showError() {
            loadingElement.style.display = 'none';
            orgChartElement.style.display = 'none';
            errorStateElement.style.display = 'block';
        }
        
        function addHoverEffects() {
            const cards = document.querySelectorAll('.staff-card');
            cards.forEach(card => {
                card.style.cursor = 'pointer';
                card.setAttribute('tabindex', '0');
                
                card.addEventListener('click', function() {
                    this.style.transform = 'translateY(-10px) scale(1.02)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                });
            });
        }
        
        // ========== INITIALIZE ==========
        
        document.addEventListener('DOMContentLoaded', fetchData);
        refreshButton.addEventListener('click', fetchData);
        
        if (useDemoButton) {
            useDemoButton.addEventListener('click', useDemoData);
        }
        
        // Animate on load
        setTimeout(() => {
            const cards = document.querySelectorAll('.staff-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 100);
            });
        }, 500);
        
    </script>
</body>
</html>
